---
title: "Effect of bottom coverage to larval presence"
subtitle: "Week6-ex1, problem statement"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


In this exercise, we continue the analysis of the white fish larval areas (week 2, exercise 3 and week4, exercise 2). This time we extend the model to include regression along two continues covariates in addition to the vegetation cover status. The additional covariates that we are interested in are the distance to sandy shore and the length of ice cover during winter. Many fishermen have observed that white fish are caught more easily from sandy shores than elsewhere during their spawning season. Moreover, white fish spawn their eggs during fall but the larvae hatch only in the spring. Hence, it has been suggested that longer ice cover period works as a shelter for the eggs. Hence, let's take a look whether there is statistical signal to these covariates. 

Let's load the data and construct covariate matrix $X$ (a matrix where the $i$'th row contains the covariates for the $i$'th sampling site), vector of area indexes $a$ (areas in the code) and vector of white fish presence-absence observations $y$.
```{r}
# Read the data
data = read.csv("white_fishes_data.csv")

# Let's then take the covariates to matrix X and standardize them
X = data[,c("DIS_SAND","ICELAST09","BOTTOMCOV")]

# And for last let's take the presence-absence observations of white fish larvae into Y
y = data$WHIBIN
```
Unlike in our previous analyses of this data we treat each sampling site as one observation and consider the triplets $\{y_i,a_i,X_i\}$ ($X_i$ is the $i$'th row of $X$) exchangeable.


We will first build the following model to analyze the data. 
\begin{align*}
y_{i} & \sim \text{Bernoulli}(\theta_{i})\\
\text{logit}(\theta_{i}) & = \alpha + X\beta \\
\alpha,\beta_1,\beta_2,\beta_3 &\sim N(0,10) \\
\end{align*}
Hence, we assume that the prior expectation of the probability to observe white fish larvae ($E[y_i]=\theta_i$) follows logit linear model where $\alpha$ is the intercept and $\beta$ is a $3\times 1$ vector of (fixed) effects of covariates. Note that the matrix notation $X\beta$ is the same as writing 
$$X\beta = \beta_1\times\text{DISSAND}+\beta_2\times\text{ICELAST09}+\beta_3\times \text{BOTTOMCOV}$$

Note also that the DIS_SAND and ICELAST09 are continuous covariates whereas BOTTOMCOV is a categorical covariate getting value 1 if the bottom is covered by vegetation and 0 if the bottom is not covered by vegetation. 
```{r}
par(mfrow=c(1,3))
hist(X$DIS_SAND)
hist(X$ICELAST09)
hist(X$BOTTOMCOV)
```
Hence, the parameter $\beta_3$ corresponds to the effect of vegetation to the observation probability of white fish larvae.
<!-- and, thus, $-\beta_3$ measures the same as quantity as $\Delta \mu$ in exercise 2 of week 4 and $\phi=\Delta \theta=\theta_0-\theta_1$ in exercise 3 of week 4. Now we have just accounted for other covariates in our analysis. -->

Before starting the analysis we standardize the continues covariates but not the categorical BOTTOMCOV covariate. If we standardized the categorical variable the interpretation of $\beta_3$ parameter would change.
```{r}
mx = colMeans(X[,1:2])
stdx = apply(X[,1:2],2,sd)
X[,1:2] = (X[,1:2]-t(replicate(dim(X)[1],mx)))/t(replicate(dim(X)[1],stdx))
```

Your tasks are now the following:

 1. Implement the model in Stan and sample from the posterior for the parameters $\alpha$ and $\beta$. Check for convergence of the MCMC chain and examine the autocorrelation of the samples. Visualize the posterior for $\alpha$ and $\beta$ and discuss the results.
 2. Calculate the posterior correlation between $\alpha$ and $\beta_3$. How does this differ from the prior correlation and why?
 3. Visualize the posterior of $\theta$ as a function of ICELAST09 when DISSAND is set to its mean value and in both cases when BOTTOMCOV=0 and BOTTOMCOV=1. That is, draw the median and 95% credible interval of the prediction function within the range from minimum to maximum value of ICELAST09 in the data.
 4. Visualize the posterior distribution of $\theta$ at location where DIS_SAND is 60 and ICELAST is 18 for both vegetated and non-vegetated bottom types as well as their difference. 
 5. How does the difference in $\theta$ for vegetated and non-vegetated bottom differ from $\phi=\Delta \theta=\theta_0-\theta_1$ in exercise 3 of week 2 and $\delta \mu$ in exercise 2 of week 4? Would you say that the result concerning the effect of vegetation is consistent in all these different analyses? Which analysis would you prefer?
 6. Visualize the posterior distribution of $\tilde{y}$ corresponding to the number sampling occasions where white fish is present out of a total 10 repeated sampling occasions at location where DIS_SAND is 60 and ICELAST is 18 for both vegetated and non-vegetated bottom types.
 
# Grading

**Total 20 points** Steps 1, 3 and 4 give 4 points each, steps 5 and 6 give 2 points each and step 2 gives 1 point if correctly solved. In other steps except 2 you may give half of the points if the step is solved half correctly. This could mean that some of the tasks have not been done (e.g. discussion is missing), there is only small typo that makes the final answer wrong or discussion is clearly not relevant or appropriate.


# References

Lari Veneranta, Richard Hudd and Jarno Vanhatalo (2013). Reproduction areas of sea-spawning Coregonids reflect the environment in shallow coastal waters. Marine Ecology Progress Series, 477:231-250. <http://www.int-res.com/abstracts/meps/v477/p231-250/>